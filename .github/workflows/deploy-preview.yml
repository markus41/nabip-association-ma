name: Preview Deployment

# Establish automated preview deployments to streamline code review
# and validation across your development environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  deployments: write

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-preview:
    name: Deploy Preview to Vercel
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Preview
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep -o 'https://[^[:space:]]*')
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: $DEPLOYMENT_URL"

      - name: Create GitHub deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.ref,
              environment: 'preview',
              description: 'Preview deployment for PR #${{ github.event.pull_request.number }}',
              auto_merge: false,
              required_contexts: [],
              transient_environment: true,
              production_environment: false
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.deployment_url }}',
              description: 'Deployment succeeded'
            });

            return deployment.data.id;

      - name: Post deployment comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';

            const message = `## ğŸš€ Preview Deployment Ready

Your changes have been deployed to a preview environment for validation and review.

**ğŸ”— Preview URL**: ${deploymentUrl}

**ğŸ“‹ Deployment Details**:
- **Environment**: Preview (ephemeral)
- **Branch**: \`${{ github.event.pull_request.head.ref }}\`
- **Commit**: \`${{ github.event.pull_request.head.sha }}\`
- **Build Time**: ${new Date().toISOString()}

**âœ… Next Steps**:
1. **Review the preview** - Test your changes in a production-like environment
2. **Validate functionality** - Ensure all features work as expected
3. **Check responsiveness** - Test across different devices and browsers
4. **Share with stakeholders** - Use the preview URL for collaborative review

**ğŸ”„ Automatic Updates**:
This preview will automatically update with each new commit to this PR.

---
*Preview deployments establish reliable validation workflows across your development environment*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Run Lighthouse CI on preview
        id: lighthouse
        continue-on-error: true
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --collect.url="${{ steps.deploy.outputs.deployment_url }}" --collect.numberOfRuns=1 || echo "Lighthouse check completed with warnings"

      - name: Post Lighthouse results
        if: steps.lighthouse.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ğŸ“Š Lighthouse Performance Audit

Automated performance testing completed for preview deployment.

**ğŸ”— Tested URL**: ${{ steps.deploy.outputs.deployment_url }}

**ğŸ“ˆ Core Web Vitals**:
- Performance metrics analyzed
- Accessibility compliance checked
- Best practices validated
- SEO optimization reviewed

**Note**: Detailed Lighthouse reports available in workflow artifacts.

---
*Lighthouse CI ensures performance standards across deployments*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Handle deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## âŒ Preview Deployment Failed

The preview deployment encountered an error. Please review the workflow logs for details.

**ğŸ” Troubleshooting Steps**:
1. Check the [Actions tab](https://github.com/${{ github.repository }}/actions) for detailed error logs
2. Verify Vercel environment variables are correctly configured
3. Ensure the build completes successfully locally (\`npm run build\`)
4. Review any dependency or configuration changes in this PR

**ğŸ”§ Common Issues**:
- Missing or invalid environment variables
- Build errors (TypeScript, linting, Vite configuration)
- Vercel project configuration issues
- Network or authentication problems

**Need Help?**
Reply with details about the error, and I can assist with troubleshooting.

---
*Automated deployment monitoring to maintain reliable delivery pipelines*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
