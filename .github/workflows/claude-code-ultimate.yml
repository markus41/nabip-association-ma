name: Claude Code - Ultimate++ Edition
on:
  # Respond to @claude mentions in various contexts
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  pull_request_review:
    types: [submitted]
  
  # Auto-engage on new issues and PRs
  issues:
    types: [opened, assigned, labeled, reopened]
  pull_request:
    types: [opened, ready_for_review, synchronize, review_requested]
  
  # Manual trigger for maintenance tasks
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Claude to perform'
        required: true
        type: choice
        options:
          - 'Work on assigned issues'
          - 'Review and edit stale PRs'
          - 'Fix all linting errors'
          - 'Triage all open issues'
          - 'Update documentation'
          - 'Generate project status report'
          - 'Analyze code quality'
          - 'Check for security issues'
      scope:
        description: 'Scope of operation'
        required: false
        default: 'all'
  
  # Schedule for automated tasks
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC for health check
    - cron: '0 */6 * * *'  # Every 6 hours - check for issues assigned to Claude

env:
  CLAUDE_USERNAME: 'claude-code[bot]'

jobs:
  # Main Claude Code job for @claude mentions and PR reviews
  claude-respond:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
      checks: write
      discussions: write
      packages: read
      statuses: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git for commits
        run: |
          git config --global user.name "Claude Code"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"
      
      - name: Detect request type
        id: detect
        run: |
          COMMENT_BODY="${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}"
          
          # Detect if user wants Claude to edit PR
          if echo "$COMMENT_BODY" | grep -qiE "@claude.*(edit|fix|update|change|modify).*(this )?pr"; then
            echo "wants_pr_edit=true" >> $GITHUB_OUTPUT
            echo "ðŸ”§ User wants PR edits"
          fi
          
          # Detect if user wants Claude to implement something
          if echo "$COMMENT_BODY" | grep -qiE "@claude.*(implement|code|write|create|build)"; then
            echo "wants_implementation=true" >> $GITHUB_OUTPUT
            echo "ðŸ’» User wants implementation"
          fi
          
          # Detect if user wants comprehensive review
          if echo "$COMMENT_BODY" | grep -qiE "@claude.*(review|analyze|check)"; then
            echo "wants_review=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ User wants review"
          fi
          
          # Detect if user wants help/guidance only
          if echo "$COMMENT_BODY" | grep -qiE "@claude.*(help|how|what|explain|suggest)"; then
            echo "wants_help=true" >> $GITHUB_OUTPUT
            echo "ðŸ’¡ User wants help"
          fi
          
          echo "comment_body<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Setup Claude context
        id: context
        run: |
          echo "Collecting repository context..."
          
          # Count open issues by priority
          echo "open_critical=$(gh issue list --label critical --state open --json number | jq 'length')" >> $GITHUB_OUTPUT
          echo "open_high=$(gh issue list --label high-priority --state open --json number | jq 'length')" >> $GITHUB_OUTPUT
          echo "open_medium=$(gh issue list --label medium-priority --state open --json number | jq 'length')" >> $GITHUB_OUTPUT
          
          # Get current PR info if applicable
          if [ "${{ github.event_name }}" == "pull_request" ] || [ "${{ github.event_name }}" == "pull_request_review_comment" ] || [ "${{ github.event_name }}" == "pull_request_review" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "pr_title=$(gh pr view $PR_NUMBER --json title -q .title || echo 'Unknown')" >> $GITHUB_OUTPUT
            echo "pr_files_changed=$(gh pr view $PR_NUMBER --json files -q '.files | length' || echo '0')" >> $GITHUB_OUTPUT
            
            # Check if PR has failing checks
            FAILING_CHECKS=$(gh pr checks $PR_NUMBER --json state -q '[.[] | select(.state != "SUCCESS")] | length' || echo '0')
            echo "pr_failing_checks=$FAILING_CHECKS" >> $GITHUB_OUTPUT
          fi
          
          # Get current issue info if applicable
          if [ "${{ github.event_name }}" == "issues" ] || [ "${{ github.event_name }}" == "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "issue_title=$(gh issue view $ISSUE_NUMBER --json title -q .title || echo 'Unknown')" >> $GITHUB_OUTPUT
            
            # Check if issue is assigned to Claude
            ASSIGNEES=$(gh issue view $ISSUE_NUMBER --json assignees -q '.assignees[].login' || echo '')
            if echo "$ASSIGNEES" | grep -q "claude-code"; then
              echo "assigned_to_claude=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          # Project stats
          echo "total_issues=$(gh issue list --state all --json number | jq 'length')" >> $GITHUB_OUTPUT
          echo "recent_prs=$(gh pr list --state open --json number | jq 'length')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          additional_permissions: |
            actions: read
            checks: write
            contents: write
            discussions: write
            issues: write
            pull-requests: write
            statuses: write
          
          prompt: |
            ${{ github.event_name == 'workflow_dispatch' && format('**Scheduled Task**: {0}', github.event.inputs.task) || '' }}
            
            **ðŸŽ¯ User Request Type**:
            ${{ steps.detect.outputs.wants_pr_edit == 'true' && 'âš ï¸ **USER WANTS YOU TO EDIT THE PR** - Make actual code changes and push commits!' || '' }}
            ${{ steps.detect.outputs.wants_implementation == 'true' && 'âš ï¸ **USER WANTS YOU TO IMPLEMENT CODE** - Write actual code and create commits!' || '' }}
            ${{ steps.detect.outputs.wants_review == 'true' && 'ðŸ“‹ **USER WANTS REVIEW** - Provide detailed code review with suggestions' || '' }}
            ${{ steps.detect.outputs.wants_help == 'true' && 'ðŸ’¡ **USER WANTS HELP** - Provide guidance and explanations' || '' }}
            
            **ðŸ“Š Repository Status**:
            - Project: NABIP AMS (Association Management System)
            - Total Issues: ${{ steps.context.outputs.total_issues }} (419 planned)
            - Open Critical: ${{ steps.context.outputs.open_critical }}
            - Open High: ${{ steps.context.outputs.open_high }}
            - Open PRs: ${{ steps.context.outputs.recent_prs }}
            
            ${{ steps.context.outputs.pr_number && format('**ðŸ”€ PR Context**:
            - PR #{0}: {1}
            - Files Changed: {2}
            - Failing Checks: {3}
            - Branch: {4}
            - âœ… You have WRITE access to this branch', steps.context.outputs.pr_number, steps.context.outputs.pr_title, steps.context.outputs.pr_files_changed, steps.context.outputs.pr_failing_checks, github.event.pull_request.head.ref) || '' }}
            
            ${{ steps.context.outputs.issue_number && format('**ðŸ“‹ Issue Context**:
            - Issue #{0}: {1}
            - Assigned to you: {2}', steps.context.outputs.issue_number, steps.context.outputs.issue_title, steps.context.outputs.assigned_to_claude || 'false') || '' }}
            
            **ðŸ› ï¸ YOUR ENHANCED CAPABILITIES**:
            
            **âœ… CODE EDITING (YOU CAN DO THIS!):**
            - Edit files directly in PRs
            - Create new files and components
            - Fix bugs and implement features
            - Refactor code for quality
            - Add tests and documentation
            - Commit and push changes
            - Update PR descriptions
            
            **âœ… REVIEW & ANALYSIS:**
            - Review code quality and security
            - Analyze performance issues
            - Suggest improvements inline
            - Identify breaking changes
            - Check test coverage
            
            **âœ… ISSUE MANAGEMENT:**
            - Work on assigned issues
            - Create sub-tasks and branches
            - Update issue status
            - Link related issues/PRs
            - Manage labels
            
            **ðŸ“š Project Knowledge**:
            - Platform: NABIP AMS with 419 tracked issues
            - **Priority #1**: Core functionality (Issues #1-7):
              - #1: Fix Add Member button
              - #2: Fix New Campaign creation
              - #3: Fix Create Course button
              - #4: Fix course preview
              - #5: Implement Member Portal login
              - #6: Fix event creation
              - #7: Fix Run Report functionality
            - Stack: React (frontend), Node.js (backend), PostgreSQL (database)
            - Design: "Software that feels inevitable" - radical simplicity
            - Brand: Navy (#003366), Teal (#008B8B), Gold (#FFD700)
            
            **ðŸŽ¬ WHEN ASKED TO EDIT A PR:**
            1. Review current code
            2. Make requested changes using Editor tool
            3. Run linting/formatting if needed
            4. Changes will auto-commit (Git is configured)
            5. Comment explaining what you changed
            6. Offer to make further edits
            
            **ðŸŽ¬ WHEN ASSIGNED TO AN ISSUE:**
            1. Read issue thoroughly
            2. Review related code
            3. Plan implementation
            4. Create branch: `issue-{number}-{description}`
            5. Implement the fix
            6. Add tests if applicable
            7. Create PR linking to issue
            
            **ðŸŽ¬ WHEN ASKED TO REVIEW:**
            1. Analyze code quality
            2. Check security and performance
            3. Add inline comments
            4. **ALWAYS OFFER TO FIX**: "Would you like me to fix these issues? Reply with '@claude fix this PR'"
            
            **ðŸ’¬ Communication:**
            - Be direct: "Editing the PR now..."
            - Explain changes made
            - Ask for confirmation on major changes
            - Offer follow-up help
            
            **ðŸš¨ CRITICAL REMINDERS**:
            - âœ… Git is configured with your credentials
            - âœ… You're on the correct branch  
            - âœ… You SHOULD edit code when asked
            - âœ… You SHOULD create commits
            - âœ… Changes will auto-commit after you run
            - âœ… Always explain what you changed
            
            **User's Request:**
            ```
            ${{ steps.detect.outputs.comment_body }}
            ```
            
            **NOW TAKE ACTION!** If asked to edit code, DO IT using the Editor tool.
          
          claude_args: |
            --allowed-tools Bash(*),Editor(*),Browser(*)
            --max-iterations 75
            --model claude-sonnet-4-20250514
            --verbose
      
      - name: Auto-commit Claude's changes
        if: success()
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… Claude made changes, committing..."
            git add -A
            
            if [ -n "${{ steps.context.outputs.pr_number }}" ]; then
              COMMIT_MSG="ðŸ¤– Claude: Updates to PR #${{ steps.context.outputs.pr_number }}"
            elif [ -n "${{ steps.context.outputs.issue_number }}" ]; then
              COMMIT_MSG="ðŸ¤– Claude: Work on #${{ steps.context.outputs.issue_number }}"
            else
              COMMIT_MSG="ðŸ¤– Claude: Automated improvements"
            fi
            
            git commit -m "$COMMIT_MSG" -m "Requested by: @${{ github.actor }}" || echo "Nothing to commit"
            git push origin HEAD || echo "Nothing to push"
            
            echo "âœ… Changes committed and pushed by Claude"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Auto-label new issues
        if: github.event_name == 'issues' && github.event.action == 'opened'
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # Feature area labels
          echo "$ISSUE_BODY" | grep -qi "member" && gh issue edit $ISSUE_NUMBER --add-label "members" || true
          echo "$ISSUE_BODY" | grep -qi "chapter" && gh issue edit $ISSUE_NUMBER --add-label "chapters" || true
          echo "$ISSUE_BODY" | grep -qi "event" && gh issue edit $ISSUE_NUMBER --add-label "events" || true
          echo "$ISSUE_BODY" | grep -qiE "campaign|email" && gh issue edit $ISSUE_NUMBER --add-label "campaigns" || true
          echo "$ISSUE_BODY" | grep -qiE "course|learning|lms" && gh issue edit $ISSUE_NUMBER --add-label "learning" || true
          echo "$ISSUE_BODY" | grep -qi "report" && gh issue edit $ISSUE_NUMBER --add-label "reports" || true
          echo "$ISSUE_BODY" | grep -qiE "security|auth|permission" && gh issue edit $ISSUE_NUMBER --add-label "security" || true
          echo "$ISSUE_BODY" | grep -qiE "ui|ux|design" && gh issue edit $ISSUE_NUMBER --add-label "ui/ux" || true
          
          # Type labels
          echo "$ISSUE_BODY" | grep -qiE "bug|broken|not working|error" && gh issue edit $ISSUE_NUMBER --add-label "bug" || true
          echo "$ISSUE_BODY" | grep -qiE "feature|enhancement|add" && gh issue edit $ISSUE_NUMBER --add-label "enhancement" || true
          
          echo "âœ… Auto-labeled issue #$ISSUE_NUMBER"
        env:
          GH_TOKEN: ${{ github.token }}
  
  # When Claude is assigned to an issue
  claude-work-on-assigned-issues:
    if: |
      (github.event_name == 'issues' && github.event.action == 'assigned' && contains(github.event.assignee.login, 'claude-code')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.task == 'Work on assigned issues') ||
      (github.event_name == 'schedule' && github.schedule == '0 */6 * * *')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config --global user.name "Claude Code"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"
      
      - name: Get assigned issues
        id: assigned
        run: |
          # Get all issues assigned to Claude
          ASSIGNED_ISSUES=$(gh issue list --assignee claude-code --state open --json number,title,labels --limit 10)
          echo "count=$(echo "$ASSIGNED_ISSUES" | jq 'length')" >> $GITHUB_OUTPUT
          echo "issues=$ASSIGNED_ISSUES" >> $GITHUB_OUTPUT
          
          if [ "$(echo "$ASSIGNED_ISSUES" | jq 'length')" -gt 0 ]; then
            echo "âœ… Found $(echo "$ASSIGNED_ISSUES" | jq 'length') issues assigned to Claude"
            echo "$ASSIGNED_ISSUES" | jq -r '.[] | "- Issue #\(.number): \(.title)"'
          else
            echo "â„¹ï¸ No issues currently assigned to Claude"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Work on assigned issues
        if: steps.assigned.outputs.count > 0
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            contents: write
            pull-requests: write
            issues: write
          prompt: |
            **ðŸŽ¯ WORK ON ASSIGNED ISSUES**
            
            You have **${{ steps.assigned.outputs.count }}** issue(s) assigned to you:
            
            ${{ steps.assigned.outputs.issues }}
            
            **Your Mission:**
            For each assigned issue (prioritize by label: critical > high > medium):
            
            1. âœ… Read the issue carefully
            2. âœ… Check if there's already a PR or branch
            3. âœ… If not started:
               - Create branch: `issue-{number}-{short-description}`
               - Implement the fix/feature
               - Add/update tests
               - Commit with: `fix(#{number}): description`
               - Push branch
               - Create PR with "Closes #{number}"
               - Comment on issue with PR link
            4. âœ… If already in progress:
               - Check out the branch
               - Continue work from where it left off
               - Push updates
               - Update PR/issue with progress
            
            **Project Context:**
            - NABIP AMS: 419 total issues
            - **Priority #1 (Issues #1-7)**: Core functionality fixes
            - Stack: React + Node.js + PostgreSQL
            - Quality: ESLint, Prettier, Jest for tests
            - Commits: Conventional commits (fix:, feat:, etc.)
            
            **Implementation Guidelines:**
            - Write production-quality code
            - Add error handling
            - Include comments for complex logic
            - Follow React best practices
            - Use NABIP brand colors where applicable
            - Test your changes
            
            **Git Workflow:**
            ```bash
            # For each issue:
            git checkout -b issue-{number}-fix
            # Implement the fix
            git add .
            git commit -m "fix(#{number}): implement {feature}"
            git push origin issue-{number}-fix
            gh pr create --title "Fix #{number}: {title}" \
                         --body "Closes #{number}\n\n## Changes\n- ..." \
                         --label "automated,claude-created"
            gh issue comment {number} --body "Created PR: #{pr_number}"
            ```
            
            **Time Management:**
            - Spend max 15 min per issue
            - If issue is complex, break into sub-tasks and comment
            - If blocked, comment on issue explaining blocker
            - Create draft PR for work-in-progress
            
            **Start with highest priority issue and work through the list!**
          claude_args: |
            --allowed-tools Bash(*),Editor(*)
            --max-iterations 150
            --model claude-sonnet-4-20250514
  
  # Auto-review and offer to fix PRs
  claude-pr-auto-review:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'ready_for_review')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      checks: write
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config --global user.name "Claude Code"
          git config --global user.email "claude-code[bot]@users.noreply.github.com"
      
      - name: Analyze PR
        id: pr-info
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          
          # Get changed files
          CHANGED=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | tr '\n' ',' | sed 's/,$//')
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT
          echo "files_count=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | wc -l)" >> $GITHUB_OUTPUT
          
          # Get diff stats
          ADDS=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}..HEAD | awk '{sum+=$1} END {print sum}')
          DELS=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }}..HEAD | awk '{sum+=$2} END {print sum}')
          echo "additions=$ADDS" >> $GITHUB_OUTPUT
          echo "deletions=$DELS" >> $GITHUB_OUTPUT
          
          # Check test status
          FAILING=$(gh pr checks $PR_NUM --json state -q '[.[] | select(.state != "SUCCESS")] | length' || echo '0')
          echo "failing_checks=$FAILING" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Claude review and offer fixes
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            contents: write
            pull-requests: write
            checks: write
          prompt: |
            **ðŸ”€ AUTO PR REVIEW + FIX OFFER**
            
            **PR Details:**
            - #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
            - Author: @${{ github.event.pull_request.user.login }}
            - Branch: `${{ github.event.pull_request.head.ref }}`
            - Files: ${{ steps.pr-info.outputs.files_count }} (+${{ steps.pr-info.outputs.additions }}/-${{ steps.pr-info.outputs.deletions }})
            - Failing checks: ${{ steps.pr-info.outputs.failing_checks }}
            
            **Review Checklist:**
            âœ… Code quality & best practices
            âœ… Security (SQL injection, XSS, auth issues)
            âœ… Performance considerations
            âœ… Test coverage
            âœ… Documentation
            âœ… Breaking changes
            âœ… NABIP AMS alignment
            âœ… Accessibility
            âœ… Error handling
            
            **Your Tasks:**
            
            1. **REVIEW** - Provide inline comments on issues
            2. **CATEGORIZE** - Label issues as: ðŸ”´ Critical, ðŸŸ¡ Important, â„¹ï¸ Nice-to-have
            3. **OFFER TO FIX** - End your review with:
               
               "**Would you like me to fix these issues?**
               
               Just reply with `@claude fix this PR` and I'll:
               - Fix [list specific items]
               - Run linting/formatting  
               - Update tests if needed
               - Push commits directly to this branch
               
               Or reply with `@claude fix [specific issue]` for individual fixes."
            
            4. **AUTO-FIX SIMPLE ISSUES** - If only minor issues like:
               - Missing semicolons
               - Formatting inconsistencies
               - Import organization
               - Simple typos
               
               Just fix them now and comment: "âœ… Auto-fixed minor issues (formatting, imports)"
            
            **Changed Files:**
            ${{ steps.pr-info.outputs.changed_files }}
            
            **Be helpful and constructive. Praise good practices too!**
          claude_args: |
            --allowed-tools Bash(gh pr *),Editor(*),Browser(*)
            --model claude-sonnet-4-20250514
      
      - name: Auto-commit minor fixes
        if: success()
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "âœ… Claude made auto-fixes"
            git add -A
            git commit -m "ðŸ¤– Claude: Auto-fix minor issues (linting, formatting)" || true
            git push origin ${{ github.event.pull_request.head.ref }} || true
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  # Weekly health check
  claude-weekly-health:
    if: github.event_name == 'schedule' && github.schedule == '0 9 * * 1'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Collect metrics
        id: metrics
        run: |
          cat > metrics.json << 'EOF'
          {
            "issues": {
              "total": $(gh issue list --state all --json number | jq 'length'),
              "open": $(gh issue list --state open --json number | jq 'length'),
              "critical_open": $(gh issue list --label critical --state open --json number | jq 'length'),
              "assigned_to_claude": $(gh issue list --assignee claude-code --state open --json number | jq 'length'),
              "closed_this_week": $(gh issue list --state closed --search "closed:>=$(date -d '7 days ago' +%Y-%m-%d)" --json number | jq 'length')
            },
            "prs": {
              "open": $(gh pr list --state open --json number | jq 'length'),
              "merged_this_week": $(gh pr list --state merged --search "merged:>=$(date -d '7 days ago' +%Y-%m-%d)" --json number | jq 'length')
            }
          }
          EOF
          echo "data=$(cat metrics.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Generate health report
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          additional_permissions: |
            issues: write
          prompt: |
            **ðŸ“Š WEEKLY HEALTH CHECK - Create Status Report**
            
            **Metrics:**
            ${{ steps.metrics.outputs.data }}
            
            **Create an issue with this template:**
            ```
            Title: ðŸ“Š Weekly Health Report - $(date +%Y-%m-%d)
            
            ## Health Score: [Calculate 0-100]
            
            ## This Week
            - Issues Closed: X
            - PRs Merged: X  
            - Issues Opened: X
            - Velocity: [Trend]
            
            ## Overall Status
            - Total Issues: 419 (planned)
            - Currently Open: X
            - Critical Remaining: X
            - Claude's Queue: X assigned issues
            
            ## Phase 1 Progress (Issues #1-129)
            [Calculate completion %]
            
            ## ðŸš¨ Concerns
            [Any red flags]
            
            ## ðŸŽ¯ Recommendations
            [Specific actions]
            
            ## Claude's Contributions
            - Issues assigned: X
            - PRs reviewed: X
            - Auto-fixes made: X
            ```
            
            Label with: `status-report`, `weekly-health`
          claude_args: |
            --allowed-tools Bash(gh issue create)
