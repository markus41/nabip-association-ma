name: PR Enhancement Bot

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to enhance'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  enhance-pr:
    name: Enhance Pull Request
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze PR
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request ||
                      await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.inputs?.pr_number || context.issue.number
                      }).then(r => r.data);

            // Get files changed
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // Calculate PR size
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;

            let size = 'small';
            if (totalChanges > 500) size = 'extra-large';
            else if (totalChanges > 200) size = 'large';
            else if (totalChanges > 50) size = 'medium';

            // Categorize changes
            const categories = {
              source: files.filter(f => f.filename.startsWith('src/')).length,
              tests: files.filter(f => f.filename.includes('test') || f.filename.includes('spec')).length,
              workflows: files.filter(f => f.filename.startsWith('.github/workflows/')).length,
              config: files.filter(f => f.filename.match(/\.(json|yml|yaml|toml|config\.(ts|js))$/)).length,
              components: files.filter(f => f.filename.match(/\.(tsx|jsx)$/)).length,
              styles: files.filter(f => f.filename.match(/\.(css|scss|sass)$/)).length,
              docs: files.filter(f => f.filename.endsWith('.md')).length
            };

            // Determine primary category
            const primaryCategory = Object.entries(categories)
              .sort((a, b) => b[1] - a[1])[0][0];

            core.setOutput('size', size);
            core.setOutput('primary_category', primaryCategory);
            core.setOutput('file_count', files.length);
            core.setOutput('additions', additions);
            core.setOutput('deletions', deletions);
            core.setOutput('has_tests', categories.tests > 0);
            core.setOutput('has_components', categories.components > 0);
            core.setOutput('has_styles', categories.styles > 0);

            return { size, primaryCategory, files: files.length };

      - name: Apply labels
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request ||
                      await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.inputs?.pr_number || context.issue.number
                      }).then(r => r.data);

            const size = '${{ steps.analyze.outputs.size }}';
            const category = '${{ steps.analyze.outputs.primary_category }}';
            const hasTests = '${{ steps.analyze.outputs.has_tests }}' === 'true';
            const hasComponents = '${{ steps.analyze.outputs.has_components }}' === 'true';
            const hasStyles = '${{ steps.analyze.outputs.has_styles }}' === 'true';

            let labels = [];

            // Size labels
            labels.push(`size:${size}`);

            // Category labels
            if (category === 'source') labels.push('enhancement');
            if (category === 'tests') labels.push('testing');
            if (category === 'workflows') labels.push('ci-cd');
            if (category === 'config') labels.push('configuration');
            if (category === 'components') labels.push('ui');
            if (category === 'styles') labels.push('styling');
            if (category === 'docs') labels.push('documentation');

            // Additional context labels
            if (hasTests) labels.push('has-tests');
            if (hasComponents) labels.push('frontend');

            // Get existing labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            // Remove old size labels
            const sizeLabels = currentLabels.filter(l => l.name.startsWith('size:'));
            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                name: label.name
              }).catch(() => {});
            }

            // Add new labels
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels
              });
            } catch (error) {
              console.log('Some labels may not exist yet. Error:', error.message);
            }

      - name: Post PR enhancement summary
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request ||
                      await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.inputs?.pr_number || context.issue.number
                      }).then(r => r.data);

            const size = '${{ steps.analyze.outputs.size }}';
            const category = '${{ steps.analyze.outputs.primary_category }}';
            const fileCount = '${{ steps.analyze.outputs.file_count }}';
            const additions = '${{ steps.analyze.outputs.additions }}';
            const deletions = '${{ steps.analyze.outputs.deletions }}';
            const hasTests = '${{ steps.analyze.outputs.has_tests }}' === 'true';

            // Check if we already posted an enhancement comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('ü§ñ PR Enhancement Summary')
            );

            let message = `## ü§ñ PR Enhancement Summary\n\n`;

            // Impact Analysis
            message += `### üìä Impact Analysis\n\n`;
            message += `- **Size**: \`${size}\` (${additions} additions, ${deletions} deletions)\n`;
            message += `- **Files Changed**: ${fileCount}\n`;
            message += `- **Primary Category**: ${category}\n`;
            message += `- **Has Tests**: ${hasTests ? '‚úÖ Yes' : '‚ö†Ô∏è No'}\n\n`;

            // Size guidance
            if (size === 'extra-large') {
              message += `> ‚ÑπÔ∏è **Large PR Notice**: This PR is quite large. Consider breaking it into smaller, focused PRs for easier review.\n\n`;
            } else if (size === 'large') {
              message += `> ‚ÑπÔ∏è **Size Notice**: This is a substantial PR. Reviewers should allocate sufficient time for thorough review.\n\n`;
            }

            // Checklist based on category
            message += `### ‚úÖ Review Checklist\n\n`;

            if (category === 'source' || category === 'components') {
              message += `**Frontend Changes:**\n`;
              message += `- [ ] Components are properly typed with TypeScript\n`;
              message += `- [ ] Accessibility standards met (ARIA, keyboard navigation)\n`;
              message += `- [ ] Responsive design tested\n`;
              message += `- [ ] Browser compatibility verified\n`;
              message += `- [ ] Performance impact assessed\n`;
              if (!hasTests) {
                message += `- [ ] ‚ö†Ô∏è **Tests added for new functionality**\n`;
              }
              message += `\n`;
            }

            if (category === 'workflows') {
              message += `**CI/CD Changes:**\n`;
              message += `- [ ] Workflow syntax is valid\n`;
              message += `- [ ] Permissions are minimal necessary\n`;
              message += `- [ ] Secrets properly referenced\n`;
              message += `- [ ] Timeout limits set appropriately\n`;
              message += `- [ ] Error handling included\n\n`;
            }

            if (category === 'config') {
              message += `**Configuration Changes:**\n`;
              message += `- [ ] Changes tested locally\n`;
              message += `- [ ] Breaking changes documented\n`;
              message += `- [ ] Backward compatibility considered\n`;
              message += `- [ ] Team notified of config changes\n\n`;
            }

            // General checklist
            message += `**General:**\n`;
            message += `- [ ] Code follows project conventions\n`;
            message += `- [ ] No console.log or debug code\n`;
            message += `- [ ] Documentation updated (if needed)\n`;
            message += `- [ ] CHANGELOG updated (for notable changes)\n\n`;

            // Merge readiness
            message += `### üö¶ Merge Readiness\n\n`;
            message += `- ${pr.mergeable !== false ? '‚úÖ' : '‚ùå'} No merge conflicts\n`;
            message += `- ${pr.draft ? '‚è∏Ô∏è' : '‚úÖ'} Not a draft PR\n`;
            message += `- ‚è≥ Awaiting CI checks\n`;
            message += `- ‚è≥ Awaiting code review\n\n`;

            message += `---\n`;
            message += `*This PR has been automatically analyzed by the PR Enhancement Bot.*\n`;
            message += `*Analysis is updated on every push.*`;

            // Post or update comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message
              });
            }
