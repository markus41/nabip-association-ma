name: Security Scanner

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]
  schedule:
    # Daily security scan at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  issues: write

jobs:
  security-scan:
    name: Comprehensive Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm_audit
        continue-on-error: true
        run: |
          npm audit --json > npm-audit.json || true
          npm audit

      - name: Run secret scanning with TruffleHog
        id: secret_scan
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --only-verified

      - name: Check for HTTP links
        id: https_check
        run: |
          echo "Checking for HTTP links in documentation..."
          grep -r "http://" . --include="*.md" --exclude-dir=node_modules --exclude-dir=.git > http-links.txt || echo "No HTTP links found"
          if [ -s http-links.txt ]; then
            echo "has_http_links=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ HTTP links found - consider upgrading to HTTPS"
            cat http-links.txt
          else
            echo "has_http_links=false" >> $GITHUB_OUTPUT
            echo "âœ… No HTTP links found"
          fi

      - name: Check for hardcoded credentials
        id: credential_check
        run: |
          echo "Checking for hardcoded credentials..."
          ISSUES=0

          # Check for common credential patterns
          if grep -r "password\s*=\s*['\"][^'\"]*['\"]" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ Potential hardcoded passwords found"
            ISSUES=$((ISSUES+1))
          fi

          if grep -r "api[_-]?key\s*=\s*['\"][^'\"]*['\"]" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ Potential hardcoded API keys found"
            ISSUES=$((ISSUES+1))
          fi

          if [ $ISSUES -eq 0 ]; then
            echo "âœ… No obvious hardcoded credentials detected"
          fi

          echo "issues=$ISSUES" >> $GITHUB_OUTPUT

      - name: Check security best practices
        id: best_practices
        run: |
          echo "Checking security best practices..."

          # Check for eval() usage
          if grep -r "eval(" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ eval() usage detected - potential security risk"
          fi

          # Check for dangerouslySetInnerHTML
          if grep -r "dangerouslySetInnerHTML" . --include="*.tsx" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âš ï¸ dangerouslySetInnerHTML usage detected - ensure proper sanitization"
          fi

          # Check .gitignore includes .env files
          if ! grep -q "^\.env" .gitignore 2>/dev/null; then
            echo "âš ï¸ .gitignore should include .env files"
          else
            echo "âœ… .env files properly gitignored"
          fi

      - name: Generate security report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let auditData = {};
            try {
              auditData = JSON.parse(fs.readFileSync('npm-audit.json', 'utf8'));
            } catch (e) {
              auditData = { metadata: { vulnerabilities: {} } };
            }

            const vulns = auditData.metadata?.vulnerabilities || {};
            const hasHttpLinks = '${{ steps.https_check.outputs.has_http_links }}' === 'true';
            const credentialIssues = parseInt('${{ steps.credential_check.outputs.issues }}' || '0');

            let message = `## ðŸ”’ Security Scan Report\n\n`;

            // Vulnerability summary
            const totalVulns = Object.values(vulns).reduce((a, b) => a + b, 0);
            if (totalVulns > 0) {
              message += `### ðŸš¨ Dependency Vulnerabilities: ${totalVulns}\n\n`;
              if (vulns.critical) message += `- ðŸ”´ **Critical**: ${vulns.critical}\n`;
              if (vulns.high) message += `- ðŸŸ  **High**: ${vulns.high}\n`;
              if (vulns.moderate) message += `- ðŸŸ¡ **Moderate**: ${vulns.moderate}\n`;
              if (vulns.low) message += `- ðŸ”µ **Low**: ${vulns.low}\n`;
              message += `\n`;
            } else {
              message += `### âœ… No Dependency Vulnerabilities Detected\n\n`;
            }

            // Security checks
            message += `### Security Checks Performed\n\n`;
            message += `- âœ… Secret scanning (TruffleHog)\n`;
            message += `- âœ… Hardcoded credential detection\n`;
            message += `- ${hasHttpLinks ? 'âš ï¸' : 'âœ…'} HTTP/HTTPS link validation\n`;
            message += `- âœ… Security best practices check\n`;
            message += `- âœ… .gitignore validation\n\n`;

            if (hasHttpLinks || credentialIssues > 0) {
              message += `### âš ï¸ Findings\n\n`;
              if (hasHttpLinks) {
                message += `- HTTP links detected - consider upgrading to HTTPS\n`;
              }
              if (credentialIssues > 0) {
                message += `- Potential hardcoded credentials detected\n`;
              }
              message += `\nPlease review workflow logs for details.\n\n`;
            }

            message += `ðŸ“Š Detailed security reports available in workflow artifacts.\n\n`;
            message += `---\n*Automated by Security Scanner*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-reports
          path: |
            npm-audit.json
            http-links.txt
          retention-days: 90
