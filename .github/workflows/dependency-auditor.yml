name: Dependency Auditor

on:
  push:
    branches: [main]
    paths:
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
  schedule:
    # Weekly on Mondays at 10 AM UTC
    - cron: '0 10 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: write

jobs:
  audit-dependencies:
    name: Audit Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        id: security
        run: |
          npm audit --json > npm-audit.json || true
          npm audit --production --json > npm-audit-prod.json || true
          echo "Security audit complete"
        continue-on-error: true

      - name: Check for outdated packages
        id: outdated
        run: |
          npm outdated --json > npm-outdated.json || true
          OUTDATED_COUNT=$(cat npm-outdated.json 2>/dev/null | jq 'length' || echo "0")
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          echo "Found $OUTDATED_COUNT outdated packages"
        continue-on-error: true

      - name: Analyze licenses
        id: licenses
        run: |
          npx license-checker --json > licenses.json || true
          echo "License analysis complete"
        continue-on-error: true

      - name: Generate dependency summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let auditData = {};
            try {
              auditData = JSON.parse(fs.readFileSync('npm-audit.json', 'utf8'));
            } catch (e) {
              auditData = { metadata: { vulnerabilities: {} } };
            }

            const vulns = auditData.metadata?.vulnerabilities || {};
            const total = Object.values(vulns).reduce((a, b) => a + b, 0);

            let message = `## ğŸ“¦ Dependency Audit Report\n\n`;
            message += `**Security Vulnerabilities:** ${total}\n`;
            if (vulns.critical) message += `- ğŸ”´ Critical: ${vulns.critical}\n`;
            if (vulns.high) message += `- ğŸŸ  High: ${vulns.high}\n`;
            if (vulns.moderate) message += `- ğŸŸ¡ Moderate: ${vulns.moderate}\n`;
            if (vulns.low) message += `- ğŸ”µ Low: ${vulns.low}\n`;
            message += `\n**Outdated Packages:** ${{ steps.outdated.outputs.outdated_count }}\n\n`;
            message += `ğŸ“Š Full audit reports available in workflow artifacts.\n\n`;
            message += `---\n*Automated by Dependency Auditor*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      - name: Upload audit reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: |
            npm-audit.json
            npm-audit-prod.json
            npm-outdated.json
            licenses.json
          retention-days: 90
