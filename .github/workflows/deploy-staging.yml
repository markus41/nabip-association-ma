name: Staging Deployment

# Establish automated staging deployments to validate changes in a production-like
# environment before release, supporting sustainable development practices

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual staging deployment'

permissions:
  contents: read
  deployments: write
  issues: write

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.deployment_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run quality checks
        run: |
          echo "üîç Running quality checks before deployment..."
          npm run lint
          npx tsc --noEmit
          echo "‚úÖ Quality checks passed"

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel environment configuration
        run: vercel pull --yes --environment=staging --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project artifacts for staging
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel Staging
        id: deploy
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} 2>&1 | grep -o 'https://[^[:space:]]*')
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed to staging: $DEPLOYMENT_URL"

      - name: Create GitHub deployment record
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'staging',
              description: '${{ github.event_name == 'workflow_dispatch' && github.event.inputs.reason || 'Automated staging deployment' }}',
              auto_merge: false,
              required_contexts: [],
              production_environment: false
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.deployment_url }}',
              description: 'Staging deployment successful'
            });

            core.setOutput('deployment_id', deployment.data.id);
            return deployment.data.id;

      - name: Run smoke tests on staging
        id: smoke_tests
        continue-on-error: true
        run: |
          echo "üß™ Running smoke tests on staging environment..."
          STAGING_URL="${{ steps.deploy.outputs.deployment_url }}"

          # Test homepage loads
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL")
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Homepage returned HTTP $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ Homepage loads successfully (HTTP 200)"

          # Test API health endpoint (if available)
          API_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$STAGING_URL/api/health" || echo "404")
          if [ "$API_CODE" == "200" ]; then
            echo "‚úÖ API health check passed"
          else
            echo "‚ÑπÔ∏è API health endpoint not available or returned HTTP $API_CODE"
          fi

          echo "‚úÖ Smoke tests completed successfully"

      - name: Run Lighthouse performance audit
        id: lighthouse
        continue-on-error: true
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun --collect.url="${{ steps.deploy.outputs.deployment_url }}" --collect.numberOfRuns=3 || echo "Lighthouse audit completed with warnings"

      - name: Notify team of staging deployment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentUrl = '${{ steps.deploy.outputs.deployment_url }}';
            const commitSha = context.sha.substring(0, 7);
            const commitMessage = context.payload.head_commit?.message || 'Deployment triggered manually';

            const message = `## üéØ Staging Deployment Successful

The latest changes have been deployed to the staging environment and are ready for validation.

**üîó Staging URL**: ${deploymentUrl}

**üìã Deployment Details**:
- **Environment**: Staging (production-like)
- **Branch**: \`main\`
- **Commit**: \`${commitSha}\` - ${commitMessage.split('\n')[0]}
- **Deployed**: ${new Date().toISOString()}
- **Deployer**: @${{ github.actor }}

**‚úÖ Quality Checks**:
- Lint validation: ‚úÖ Passed
- TypeScript compilation: ‚úÖ Passed
- Build process: ‚úÖ Successful
- Smoke tests: ${{ steps.smoke_tests.outcome == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Check logs' }}

**üß™ Validation Steps**:
1. **Functional Testing** - Verify core user workflows
2. **Integration Testing** - Check third-party integrations (Supabase, Stripe)
3. **Performance Testing** - Review Lighthouse metrics
4. **Cross-Browser Testing** - Test on Chrome, Firefox, Safari
5. **Mobile Responsiveness** - Validate on mobile devices

**üìä Next Steps**:
- Validate changes in staging environment
- Report any issues discovered
- Approve for production deployment when ready

---
*Automated staging deployments establishing reliable validation workflows across your environment*

_Deployment ${{ steps.deployment.outputs.deployment_id }}_`;

            // Create issue comment for manual deploys or failed smoke tests
            if (context.eventName === 'workflow_dispatch' || '${{ steps.smoke_tests.outcome }}' !== 'success') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Staging Deployment - ${new Date().toISOString().split('T')[0]}`,
                body: message,
                labels: ['deployment', 'staging']
              });
            }

      - name: Update deployment status on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if ('${{ steps.deployment.outputs.deployment_id }}') {
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: '${{ steps.deployment.outputs.deployment_id }}',
                state: 'failure',
                description: 'Staging deployment failed'
              });
            }

            // Create issue for failed deployment
            const message = `## ‚ùå Staging Deployment Failed

The automated deployment to staging environment encountered an error.

**üîç Failure Details**:
- **Branch**: \`main\`
- **Commit**: \`${context.sha.substring(0, 7)}\`
- **Triggered by**: @${{ github.actor }}
- **Time**: ${new Date().toISOString()}

**üìã Troubleshooting Steps**:
1. Review [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
2. Verify Vercel environment variables and project configuration
3. Check for build errors or failing quality checks
4. Ensure all dependencies are correctly specified in package.json
5. Test the build process locally: \`npm run build\`

**üö® Impact**:
- Staging environment may be in an inconsistent state
- Latest changes not available for testing
- Production deployment blocked until resolved

**üîß Common Issues**:
- Environment variable misconfigurations
- Build failures (TypeScript errors, missing dependencies)
- Vercel project settings issues
- Network or authentication problems

**Next Steps**:
1. Identify and fix the root cause
2. Test locally to ensure build succeeds
3. Push fix to main branch to trigger automatic redeployment

---
*Automated deployment monitoring maintaining reliable delivery pipelines*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Staging Deployment Failed - ${new Date().toISOString().split('T')[0]}`,
              body: message,
              labels: ['deployment', 'staging', 'high-priority', 'bug']
            });

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-deployment-${{ github.run_number }}
          path: |
            .vercel/
          retention-days: 30
